存储层包含两部分，一部分是ApusData的内建存储层，另一部分包含ApusData访问用户保存在COS上的外部数据。对于内建存储层，用户通过http或者tcp连接，将数据写入到ApusData，ApusData再将其转为内置存储层的数据存储结构，写入到COS，同时将索引文件也写入到COS。对于用户直接写入到COS上的只读数据，ApusData会为其创建索引文件，保存到COS中，用以加速查询。

ApusData 对外提供低成本、高性能、简单易用的日志分析系统，系统的主要应用场景是执行大量需要进行读优化的 ad-hoc 查询，对于内建存储部分，我们需要设计专门的数据存储格式，来加速查询。日志分析场景下，查询通常只会查询多个列中的几个列，如果采用行存（row-oriented storage）势必会引入不必要的IO开销，因此采用列式存储（column-oriented storage）是非常直观的选择。具体来说，列式存储在数据分析场景下包含如下的优势：

1. 减少IO。当查询只需要访问一张表中的个别列时，其他列是没必要从磁盘加载到内存中的。如果使用行存，由于数据是按行写入的，因此不相关的列始终与目标列保存在磁盘上的同一个block内，在查询时，这部分IO无法省略。
2. 提高 CPU 缓存命中率。数据从主存加载到CPU cache时，是以 cache line 为单位的。在列存模式下，由于不相关列与目标列被一起加载到内存，因此不相关列势必会占用 cache line 的空间，导致 cache 命中率降低。
3. 提高压缩效率。在列存模式下，相同数据类型的数据保存在一起因此可以极大地提高压缩效率。高效的压缩可以减少数据从磁盘加载到内存的时间。
4. 向量化处理。现代的CPU架构里，提供了能够并行处理数组中多个元素的指令，即SIMD（Single Instruction Multiple Data)。列式存储下，数据从磁盘加载到内存后自然就是按照列分布的，那么对于一些操作，比如compare，来说，就可以很方便使用SIMD指令处理数据。

选定列式存储后，需要选择列存的存储形式。实现比较早期的列存分析型数据库，如Vertical，Clickhouse，都是采用自己专用的二进制存储格式；在 Hadoop 生态下，为了方便列存文件在不同系统之间共享使用，出现了统一的列存格式，比如 Apache Parquet，Apache ORC 等。

列式存储有两种存储形式，一种是纯列存（Wide），每个列都保存在一个单独的数据文件内，还有一种是比较紧凑的格式（Compact），列数据都保存在同一个文件内，同一个列的数据保存在文件内的相邻的位置。Clickhouse 采用了两种形式，当数据量比较少时，数据以 Compact 模式保存，当数据比较多时，以 Wide 模式保存。 Apache Parquet 和 Apache ORC 都是 Compact 模式。

ApusData 的内置存储需要将数据保存到 COS，如果采用 Wide 模式，会导致 COS 上保存的对象数量过多，有潜在的元数据管理压力。